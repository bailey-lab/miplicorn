---
title: "Analysis Tools Demonstration"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Analysis Tools Demonstration}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(MIPr)
library(ggplot2)

mytheme <- list(theme_classic(), 
  theme(plot.title = element_text(hjust = 0.5, size = 12),
        axis.title = element_text(size = 10),
        legend.position = "right",
        legend.title = element_text(size = 10),
        legend.text = element_text(size = 10)))
```

# Creating Analysis Tibbles
This technique allows us to retain all the information initially present in the
.csv files. In particular, we are able to keep onto information such as the gene
ID, and whether the site was targeted or not. I would urge for the use of
solution 2, as even though this information may not be useful immediately, there
may come a time down the road where having the extra information is important.
```{r analysis aa tibble, message = FALSE}
reference_aa_table <- system.file("extdata", "reference_AA_table.csv", 
                               package = "MIPr", mustWork = TRUE)
alternate_aa_table <- system.file("extdata", "alternate_AA_table.csv", 
                               package = "MIPr", mustWork = TRUE)
coverage_aa_table  <- system.file("extdata", "coverage_AA_table.csv",  
                               package = "MIPr", mustWork = TRUE)

analysis_aa_tibble <- MIPr::read(reference_aa_table, 
                                 alternate_aa_table, 
                                 coverage_aa_table)
```

# Extracting clinically relevant mutations
We can define a vector with which genes we would like to focus on. This list can
be built in to an R package and can thus be updated and changed. Using this
defined vector, we can extract the data of interest and sort the data, first
alphabetically by gene and then by mutation location.
```{r relevant mutations}
relevant_mutations <- c("dhps", "k13", "atp6", "crt", 
                        "cytb", "mdr1", "mdr2", "dhfr-ts")

clinical_summary <- analysis_aa_tibble %>% 
  # Select only genes that are considered to have relevant mutations
  dplyr::filter(gene %in% relevant_mutations) %>% 
  dplyr::relocate(aa_change, .after = gene) %>% 
  # Create a column which indicates the location of the amino acid change
  dplyr::mutate(aa_location = as.numeric(stringr::str_extract(aa_change, "\\d+")),
                .after = aa_change) %>% 
  # Sort the dataset first by the gene, then by the amino acid change location
  dplyr::arrange(gene, aa_location) %>% 
  # Convert gene, mutation, name, and aa_change to factors, preserving their
  # order. This will make it so in plots the data is sorted.
  dplyr::mutate(gene = forcats::as_factor(gene),
    mutation_name = forcats::as_factor(mutation_name),
    aa_change = forcats::as_factor(aa_change))
```

To test that our data is properly sorted, we can make a quick plot showing the
average coverage by mutation location.
```{r relevant mutations plot, message = FALSE}
clinical_summary %>% 
  dplyr::group_by(mutation_name, aa_change, gene) %>% 
  dplyr::summarise(coverage = mean(coverage)) %>% 
ggplot(aes(x = aa_change, y = coverage, fill = gene)) +
  geom_col() +
  labs(y = "Average Coverage", x = "Amino Acid Change", title = "Average Coverage by Mutation Site") +
  scale_fill_discrete(name = "Gene") +
  mytheme + # Neat trick for figures is to define a theme elsewhere and then just have this line of code
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

## Is a mutation "validated"?
We create a fake list of validated mutations and combine this data with our
previous tibble. We then show two plots which can be used to examine validated
and suspected mutations.
```{r mutation validation}
# Create a fake list of validated mutations
set.seed(100)
valid_mutations <- tibble::tibble(
  mutation = unique(clinical_summary$mutation_name),
  validated = sample(c("validated", "suspect"), replace = TRUE, size = length(unique(clinical_summary$mutation_name))))

# Combine the fake list of validated mutations with the previous tibble
extended_summary <- clinical_summary %>% 
  dplyr::left_join(valid_mutations, by = c("mutation_name" = "mutation")) %>% 
  dplyr::relocate(validated, .after = mutation_name)
```

```{r mutation validation plot, message = FALSE}
extended_summary %>% 
  dplyr::group_by(mutation_name, aa_change, gene, validated) %>% 
  dplyr::summarise(coverage = mean(coverage)) %>% 
ggplot(aes(x = aa_change, y = coverage, fill = gene, alpha = validated)) +
  geom_col() +
  labs(y = "Average Coverage", x = "Amino Acid Change", title = "Average Coverage by Mutation Site") +
  scale_fill_discrete(name = "Gene") +
  mytheme + # Neat trick for figures is to define a theme elsewhere and then just have this line of code
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

extended_summary %>% 
  dplyr::group_by(mutation_name, aa_change, gene, validated) %>% 
  dplyr::summarise(coverage = mean(coverage)) %>% 
ggplot(aes(x = aa_change, y = coverage, fill = gene)) +
  geom_col() +
  facet_grid(validated ~ .) +
  labs(y = "Average Coverage", x = "Amino Acid Change", title = "Average Coverage by Mutation Site") +
  scale_fill_discrete(name = "Gene") +
  mytheme + # Neat trick for figures is to define a theme elsewhere and then just have this line of code
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```
